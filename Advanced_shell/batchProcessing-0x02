#!/bin/bash

# Configuration
API_URL="https://pokeapi.co/api/v2/pokemon/"
MAX_RETRIES=3
LOG_FILE="error_log.txt"
POKEMON_LIST=("pikachu" "charizard" "missingno" "ditto" "mewtwo") # 'missingno' is intentionally invalid
TEMP_FILE="/tmp/pokemon_data_$$.json" # Use a temp file for safety

# Clear log file from previous runs
> "$LOG_FILE"

# Function to fetch data with retry logic
fetch_pokemon_data() {
    local pokemon_name=$1
    local attempt=0
    local http_code=0
    local curl_status=0

    echo "--- Processing $pokemon_name ---"

    while [ $attempt -lt $MAX_RETRIES ]; do
        attempt=$((attempt + 1))
        
        # Use curl to fetch the data, outputting the HTTP status code to stderr
        # -s: Silent mode
        # -w: Write out a specific variable (HTTP status code)
        # -o: Write response body to a file
        http_code=$(curl -s -o "$TEMP_FILE" -w "%{http_code}" "${API_URL}${pokemon_name}")
        curl_status=$?
        
        # Check for successful curl execution (network/connection error)
        if [ $curl_status -eq 0 ]; then
            
            # Check for successful HTTP status code (API error)
            if [ "$http_code" -eq 200 ]; then
                echo "SUCCESS: Fetched $pokemon_name (Attempt $attempt)."
                # Data is now available in $TEMP_FILE for further processing (Task 3, etc.)
                
                # Example: Print height and weight
                echo "Data Snippet: $(jq -r '.name + ", " + (.height|tostring) + ", " + (.weight|tostring)' "$TEMP_FILE")"

                rm -f "$TEMP_FILE"
                return 0 # Success
            elif [ "$http_code" -eq 404 ]; then
                echo "SKIPPED: $pokemon_name not found on API (HTTP $http_code)." | tee -a "$LOG_FILE"
                rm -f "$TEMP_FILE"
                return 1 # Non-retryable failure (invalid resource)
            else
                # Other transient HTTP error (e.g., 500, 502)
                echo "ERROR: API returned HTTP $http_code for $pokemon_name (Attempt $attempt)."
            fi
        else
            # Curl network/connection error (e.g., DNS failure, timeout)
            echo "ERROR: Curl failed with exit status $curl_status for $pokemon_name (Attempt $attempt)."
        fi

        # If we failed and this is not the last attempt, wait before retrying
        if [ $attempt -lt $MAX_RETRIES ]; then
            sleep 2 # Wait 2 seconds before the next retry
        fi
    done

    # If the loop finishes without a 'return 0', all retries failed.
    echo "FATAL: Failed to fetch $pokemon_name after $MAX_RETRIES attempts. Skipping." | tee -a "$LOG_FILE"
    rm -f "$TEMP_FILE"
    return 1 # Final failure
}

## Main Execution Loop
for poke in "${POKEMON_LIST[@]}"; do
    fetch_pokemon_data "$poke"
done

echo "-------------------------------------"
echo "Job finished. Check $LOG_FILE for failed operations."
echo "-------------------------------------"
